{"version":3,"sources":["js/wasmHandler.js","js/app.js"],"names":["combineMultithreadedData","ctx","multithreadingWorkers","multithreadingAmount","navigator","hardwareConcurrency","webworkerLoaded","w","Promise","r","addEventListener","once","setHandlerSetting","name","val","setWorkerSettings","i","postMessage","cloneWorkerSettings","init","_ctx","loadingCallback","loads","worker","Worker","onmessage","handleMultithreaderReturn","push","combineImageData","combineImageDataIndex","e","data","width","height","startX","imageData","ImageData","putImageData","renderFrame","xCam","yCam","scale","Array","stripWidth","Math","floor","waits","all","canvas","fps","autozoomInterval","scaleFactor","frame","keys","autozoom","autozoomSpeed","scaleCanvas","window","innerWidth","innerHeight","style","loadingEl","document","getElementById","getContext","WasmHandler","x","textContent","className","onresize","oncontextmenu","preventDefault","onkeydown","key","toLowerCase","onkeyup","dragging","lastDragX","lastDragY","scaleX","scaleY","y","wheelHandler","console","log","zoom","deltaY","mouseInMandelBeforeX","clientX","mouseInMandelBeforeY","clientY","onmousedown","mouseDownHandler","which","setInterval","clearInterval","onmousemove","mouseMoveHandler","onmouseup","mouseUpHandler","onwheel","lastUpdateTime","performance","now","panAmount","scalePanAmount","debugEl","resScaleEl","oninput","value","maxIterationEl","autozoomSpeedEl","linesBetweenEl","checked","combineDataEl","update","timeNow","deltaTime","round","receivingGoodInput","drawDebug","toFixed","requestAnimationFrame"],"mappings":"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","file":"app.8a70c5d8.js","sourceRoot":"../src","sourcesContent":["export let combineMultithreadedData = true;\n\nlet multithreadingWorkers = [];\nexport let multithreadingAmount = navigator.hardwareConcurrency || 4; // Use 4 if can't get CPU core / thread count\nlet ctx;\n\n/*let linesBetweenColumns = false;\nexport function setLinesBetweenColumns(val) { // Allowing setting it externally\n  linesBetweenColumns = val;\n}*/\n\nconst webworkerLoaded = w => new Promise(r => w.addEventListener(\"message\", r, { once: true }));\n\nexport async function setHandlerSetting(name, val) {\n  switch (name) {\n    case 'combineMultithreadedData':\n      combineMultithreadedData = val;\n      break;\n  }\n}\n\nexport async function setWorkerSettings(name, val) {\n  for (let i = 0; i < multithreadingAmount; i++) {\n    multithreadingWorkers[i].postMessage([name, val]);\n  }\n\n  cloneWorkerSettings[name] = val;\n}\n\nexport async function init(_ctx, loadingCallback = () => {}) {\n  loadingCallback('Loading multithreading workers');\n\n  ctx = _ctx;\n\n  let loads = [];\n  for (let i = 0; i < multithreadingAmount; i++) {\n    loadingCallback(`Spawning worker ${i + 1}`);\n\n    let worker = new Worker('wasmMultithread.js');\n\n    worker.onmessage = handleMultithreaderReturn;\n\n    multithreadingWorkers.push(worker);\n    loads.push(webworkerLoaded(worker));\n  }\n\n  //let startTime = performance.now();\n\n  for (let i = 0; i < multithreadingAmount; i++) {\n    loadingCallback(`Waiting for worker ${i + 1} to load`);\n    await loads[i];\n  }\n\n  loadingCallback('Loaded all multithreading workers');\n\n  //await Promise.all(loads);\n\n  //console.log(`${(performance.now() - startTime).toFixed(2)}ms`);\n\n  //await (new Promise(resolve => setTimeout(resolve, 1000)));\n}\n\nlet combineImageData;\nlet combineImageDataIndex;\nfunction handleMultithreaderReturn(e) {\n  if (e.data === 'loaded') return;\n\n  let [i, width, height, data] = e.data;\n\n  let startX = (i * width);\n\n  let imageData = new ImageData(data, width, height);\n\n  if (combineMultithreadedData) {\n    combineImageData[combineImageDataIndex] = [imageData, startX];\n    combineImageDataIndex++;\n\n    if (combineImageDataIndex === multithreadingAmount) {\n      for (let i = 0; i < multithreadingAmount; i++) {\n        ctx.putImageData(combineImageData[i][0], combineImageData[i][1], 0);\n      }\n    }\n\n    return;\n  }\n\n  ctx.putImageData(imageData, startX, 0);\n}\n\nexport async function renderFrame(width, height, xCam, yCam, scale) {\n  combineImageData = Array(multithreadingAmount);\n  combineImageDataIndex = 0;\n\n  let stripWidth = Math.floor(width / multithreadingAmount);\n\n  //let stripCurrent = 0;\n  let waits = [];\n  for (let i = 0; i < multithreadingAmount; i++) {\n    multithreadingWorkers[i].postMessage([i, stripWidth, width, height, xCam, yCam, scale]);\n\n    //stripCurrent += stripWidth;\n\n    waits.push(webworkerLoaded(multithreadingWorkers[i]));\n  }\n\n  await Promise.all(waits);\n\n  //module.render_frame(ctx, width, height, xCam, yCam, scale);\n}","import * as WasmHandler from './wasmHandler';\n\n(async function () { let canvas, ctx;\n\nlet scaleFactor = 2;\n\nlet width = 0;\nlet height = 0;\n\nlet frame = 0;\nlet fps;\n\nlet xCam = 0;\nlet yCam = 0;\n\nlet scale = 1.2;\n\nlet keys = [];\n\nlet autozoom = false;\nlet autozoomSpeed = 1;\nlet autozoomInterval;\n\nfunction scaleCanvas() {\n  width = Math.floor(window.innerWidth / scaleFactor);\n  height = Math.floor(window.innerHeight / scaleFactor);\n\n  canvas.width = width;\n  canvas.height = height;\n\n  canvas.style.width = `${window.innerWidth}px`;\n  canvas.style.height = `${window.innerHeight}px`;\n}\n\nlet loadingEl = document.getElementById('loading');\n\ncanvas = document.getElementById('canvas');\nctx = canvas.getContext('2d');\n\nWasmHandler.init(ctx, (x) => {\n  loadingEl.textContent = x;\n\n  if (x === 'Loaded all multithreading workers') {\n    loadingEl.className = 'hide';\n  }\n});\n\nscaleCanvas();\nwindow.onresize = scaleCanvas;\n  \ndocument.oncontextmenu = function(e) {\n  e.preventDefault();\n  return false;\n}\n  \ndocument.onkeydown = function(e) {\n  let key = e.key.toLowerCase();\n\n  keys[key] = true;\n};\n\ndocument.onkeyup = function(e) {\n  let key = e.key.toLowerCase();\n    \n  keys[key] = false;\n};\n\nlet dragging = false;\nlet lastDragX = 0;\nlet lastDragY = 0;\n\nfunction mouseDownHandler(e) {\n  if (e.which === 3) { // Right click - auto zoom\n    if (autozoom === false) {\n      autozoom = {clientX: e.clientX, clientY: e.clientY, deltaY: -autozoomSpeed};\n      autozoomInterval = setInterval(() => { wheelHandler(autozoom); });\n    } else {\n      clearInterval(autozoomInterval);\n      autozoom = false;\n    }\n\n    return;\n  }\n\n  dragging = true;\n\n  lastDragX = e.clientX;\n  lastDragY = e.clientY;\n\n  //WasmHandler.setHandlerSetting('combineMultithreadedData', true);\n}\n\nfunction mouseMoveHandler(e) {\n  if (!dragging) return;\n\n  let x = e.clientX;\n  let y = e.clientY;\n\n  let diffX = x - lastDragX;\n  let diffY = y - lastDragY;\n\n  xCam -= diffX / 400;\n  yCam -= diffY / 400;\n\n  lastDragX = x;\n  lastDragY = y;\n}\n\nfunction mouseUpHandler(e) {\n  dragging = false;\n\n  //WasmHandler.setHandlerSetting('combineMultithreadedData', false);\n}\n\nfunction scaleX(x) {\n  return ((x / (width / 3.5)) - 1.75) * scale + xCam;\n}\n\nfunction scaleY(y) {\n  return (((y / (height / 2.0)) - 1.0)) * scale + yCam;\n}\n\nfunction wheelHandler(e) {\n  console.log(e);\n\n  let zoom = (e.deltaY * 0.001);\n\n  //xCam -= ((scaleX(e.clientX / scaleFactor) * zoom) - xCam) / scaleFactor;\n\n  let mouseInMandelBeforeX = scaleX(e.clientX / scaleFactor) - xCam;\n  let mouseInMandelBeforeY = scaleY(e.clientY / scaleFactor) - yCam;\n\n  //console.log(mouseInMandelBeforeX);\n\n  scale *= 1 + zoom;\n\n  xCam -= (scaleX(e.clientX / scaleFactor) - xCam) - mouseInMandelBeforeX;\n\n  yCam -= (scaleY(e.clientY / scaleFactor) - yCam) - mouseInMandelBeforeY;\n\n  //let diffX = (scaleX(e.clientX / scaleFactor) - xCam) + mouseInMandelBeforeX;\n  //console.log(diffX)\n\n  //xCam += diffX;\n\n  //xCam -= scaleX(e.clientX) * zoom / scaleFactor;\n\n  //xCam = xCam - scaleX(e.clientX / window.innerWidth * (sWidthAfter - sWidthBefore));\n  //yCam = yCam - scaleY(e.clientY / window.innerHeight * (sHeightAfter - sHeightBefore));\n\n  if (e.preventDefault) e.preventDefault();\n}\n\ncanvas.onmousedown = mouseDownHandler;\ncanvas.onmousemove = mouseMoveHandler;\ncanvas.onmouseup = mouseUpHandler;\n\ncanvas.onwheel = wheelHandler;\n\nlet lastUpdateTime = performance.now();\n\nlet panAmount = 0.02;\n\nfunction scalePanAmount() {\n  return panAmount * scale;\n}\n\nasync function update() {\n  let timeNow = performance.now();\n  let deltaTime = (timeNow - lastUpdateTime) / 1000;\n  lastUpdateTime = timeNow;\n\n  fps = Math.round(1 / deltaTime);\n\n  let receivingGoodInput = false;\n\n  if (keys['w'] || keys['arrowup']) {\n    yCam -= scalePanAmount();\n\n    receivingGoodInput = true;\n  }\n\n  if (keys['s'] || keys['arrowdown']) {\n    yCam += scalePanAmount();\n\n    receivingGoodInput = true;\n  }\n\n  if (keys['a'] || keys['arrowleft']) {\n    xCam -= scalePanAmount();\n\n    receivingGoodInput = true;\n  }\n\n  if (keys['d'] || keys['arrowright']) {\n    xCam += scalePanAmount();\n\n    receivingGoodInput = true;\n  }\n\n  if (keys['z']) {\n    scale *= 0.99;\n\n    receivingGoodInput = true;\n  }\n\n  if (keys['x']) {\n    scale *= 1.01;\n\n    receivingGoodInput = true;\n  }\n\n\n  await WasmHandler.renderFrame(width, height, xCam, yCam, scale);\n\n  frame++;\n\n  drawDebug();\n\n  requestAnimationFrame(update);\n}\n\nlet debugEl = document.getElementById('debug');\n\nlet resScaleEl = document.getElementById('resScale');\n\nresScaleEl.oninput = () => {\n  scaleFactor = resScaleEl.value;\n\n  scaleCanvas();\n};\n\nlet maxIterationEl = document.getElementById('maxIteration');\n\nmaxIterationEl.oninput = () => {\n  WasmHandler.setWorkerSettings('maxIteration', maxIterationEl.value);\n  WasmHandler.setWorkerSettings('maxIterationColorScale', 255 / maxIterationEl.value);\n};\n\nlet autozoomSpeedEl = document.getElementById('autozoomSpeed');\n\nautozoomSpeedEl.oninput = () => {\n  autozoomSpeed = autozoomSpeedEl.value;\n  autozoom.deltaY = -autozoomSpeed;\n}\n\nlet linesBetweenEl = document.getElementById('linesBetween');\n\nlinesBetweenEl.oninput = () => {\n  WasmHandler.setWorkerSettings('linesBetweenMultithreadColumns', linesBetweenEl.checked);\n};\n\nlet combineDataEl = document.getElementById('combineData');\n\ncombineDataEl.oninput = () => {\n  WasmHandler.setHandlerSetting('combineMultithreadedData', combineDataEl.checked);\n};\n\nasync function drawDebug() {\n  debugEl.textContent = `F: ${frame} FPS: ${fps}\nCamera Position: ${xCam.toFixed(2)}, ${yCam.toFixed(2)} Scale: ${scale.toFixed(2)}\nResolution: Scaled: ${width}x${height}, Scale Factor: ${scaleFactor}, Raw: ${window.innerWidth}x${window.innerHeight}\nMultithreading: Workers: ${WasmHandler.multithreadingAmount}, Combine Multithreaded Data: ${WasmHandler.combineMultithreadedData}\n`;\n}\n\nupdate();\n})();"]}